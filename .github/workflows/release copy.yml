name: Publish MiaoWuTodo

on:
  push:
    tags:
      - 'v*' # æ¨é€ v å¼€å¤´çš„ tag æ—¶è§¦å‘å·¥ä½œæµ

jobs:
  build-and-sign:
    permissions:
      contents: write # èµ‹äºˆ GITHUB_TOKEN å†™å…¥ Release çš„æƒé™
    strategy:
      fail-fast: false # ä¸€ä¸ªå¹³å°å¤±è´¥ä¸å½±å“å…¶ä»–å¹³å°ç»§ç»­æ„å»º
      matrix:
        include:
          - platform: macos-latest
            os: macOS
            target: universal-apple-darwin
          - platform: windows-latest
            os: Windows
            target: x86_64-pc-windows-msvc
    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: ${{ matrix.target }}

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Install frontend dependencies
        run: npm install

      - name: Build frontend
        run: npm run build

      # macOS è¯ä¹¦é…ç½®
      - name: Import Apple Certificate
        if: matrix.os == 'macOS'
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          echo "ğŸ” å¯¼å…¥Appleå¼€å‘è€…è¯ä¹¦..."
          echo $APPLE_CERTIFICATE | base64 --decode > certificate.p12
          security create-keychain -p "$APPLE_CERTIFICATE_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$APPLE_CERTIFICATE_PASSWORD" build.keychain
          security import certificate.p12 -k build.keychain -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$APPLE_CERTIFICATE_PASSWORD" build.keychain
          rm certificate.p12
          echo "âœ… è¯ä¹¦å¯¼å…¥å®Œæˆ"

      - name: Create Apple API Key file
        if: matrix.os == 'macOS'
        run: |
          echo "ğŸ“ åˆ›å»ºApple API Keyæ–‡ä»¶..."
          echo '${{ secrets.APPLE_API_KEY_CONTENT }}' > AuthKey_${{ secrets.APPLE_API_KEY_ID }}.p8
          echo "âœ… API Keyæ–‡ä»¶åˆ›å»ºå®Œæˆ"

      - name: Verify Apple Certificate
        if: matrix.os == 'macOS'
        run: |
          echo "ğŸ” éªŒè¯è¯ä¹¦..."
          CERT_INFO=$(security find-identity -v -p codesigning build.keychain | grep "Developer ID Application")
          CERT_ID=$(echo "$CERT_INFO" | awk -F'"' '{print $2}')
          echo "CERT_ID=$CERT_ID" >> $GITHUB_ENV
          echo "âœ… æ‰¾åˆ°è¯ä¹¦: $CERT_ID"

      # æ„å»ºæœªç­¾åçš„åº”ç”¨
      - name: Build Tauri app (unsigned)
        run: |
          echo "ğŸ”¨ å¼€å§‹æ„å»ºTauriåº”ç”¨..."
          cd src-tauri
          cargo tauri build --target ${{ matrix.target }} --verbose
          echo "âœ… åº”ç”¨æ„å»ºå®Œæˆ"

      # macOS ç­¾åæµç¨‹
      - name: Sign macOS app
        if: matrix.os == 'macOS'
        run: |
          echo "âœï¸ å¼€å§‹ç­¾åmacOSåº”ç”¨..."
          
          # æ‰¾åˆ°æ„å»ºçš„appæ–‡ä»¶
          APP_PATH=$(find src-tauri/target/${{ matrix.target }}/release/bundle/macos -name "*.app" | head -1)
          echo "ğŸ“± åº”ç”¨è·¯å¾„: $APP_PATH"
          
          # ç­¾ååº”ç”¨
          echo "ğŸ” ç­¾ååº”ç”¨..."
          codesign --force --options runtime --sign "${{ env.CERT_ID }}" --verbose "$APP_PATH"
          
          # éªŒè¯ç­¾å
          echo "ğŸ” éªŒè¯ç­¾å..."
          codesign --verify --verbose "$APP_PATH"
          spctl --assess --verbose "$APP_PATH"
          
          echo "âœ… macOSåº”ç”¨ç­¾åå®Œæˆ"

      # åˆ›å»ºDMGå¹¶ç­¾å (macOS)
      - name: Create and sign DMG
        if: matrix.os == 'macOS'
        run: |
          echo "ğŸ“¦ åˆ›å»ºDMGæ–‡ä»¶..."
          
          APP_PATH=$(find src-tauri/target/${{ matrix.target }}/release/bundle/macos -name "*.app" | head -1)
          APP_NAME=$(basename "$APP_PATH" .app)
          DMG_PATH="src-tauri/target/${{ matrix.target }}/release/bundle/macos/${APP_NAME}.dmg"
          
          # åˆ›å»ºDMG
          hdiutil create -volname "$APP_NAME" -srcfolder "$APP_PATH" -ov -format UDZO "$DMG_PATH"
          
          # ç­¾åDMG
          echo "âœï¸ ç­¾åDMG..."
          codesign --force --sign "${{ env.CERT_ID }}" "$DMG_PATH"
          
          # éªŒè¯DMGç­¾å
          echo "ğŸ” éªŒè¯DMGç­¾å..."
          codesign --verify --verbose "$DMG_PATH"
          
          echo "âœ… DMGåˆ›å»ºå’Œç­¾åå®Œæˆ"

      # å…¬è¯ (macOS)
      - name: Notarize macOS app
        if: matrix.os == 'macOS'
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          echo "ğŸ“‹ å¼€å§‹å…¬è¯æµç¨‹..."
          
          DMG_PATH=$(find src-tauri/target/${{ matrix.target }}/release/bundle/macos -name "*.dmg" | head -1)
          
          # ä¸Šä¼ å…¬è¯
          echo "â¬†ï¸ ä¸Šä¼ åº”ç”¨è¿›è¡Œå…¬è¯..."
          xcrun notarytool submit "$DMG_PATH" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait
          
          # è£…è®¢å…¬è¯ç¥¨æ®
          echo "ğŸ“ è£…è®¢å…¬è¯ç¥¨æ®..."
          xcrun stapler staple "$DMG_PATH"
          
          # éªŒè¯å…¬è¯
          echo "ğŸ” éªŒè¯å…¬è¯..."
          xcrun stapler validate "$DMG_PATH"
          spctl --assess --type open --context context:primary-signature "$DMG_PATH"
          
          echo "âœ… å…¬è¯å®Œæˆ"

      # Windows ç­¾å (å¦‚æœæœ‰è¯ä¹¦)
      - name: Sign Windows executable
        if: matrix.os == 'Windows' && secrets.WINDOWS_CERTIFICATE != ''
        run: |
          echo "âœï¸ ç­¾åWindowsåº”ç”¨..."
          # è¿™é‡Œå¯ä»¥æ·»åŠ Windowsä»£ç ç­¾åé€»è¾‘
          # éœ€è¦é…ç½®Windowsè¯ä¹¦ç›¸å…³çš„secrets
          echo "âš ï¸ Windowsç­¾ååŠŸèƒ½å¾…é…ç½®"

      # æ”¶é›†æ„å»ºäº§ç‰©
      - name: Collect build artifacts
        run: |
          echo "ğŸ“¦ æ”¶é›†æ„å»ºäº§ç‰©..."
          mkdir -p artifacts
          
          if [ "${{ matrix.os }}" = "macOS" ]; then
            # å¤åˆ¶macOSäº§ç‰©
            find src-tauri/target/${{ matrix.target }}/release/bundle -name "*.dmg" -exec cp {} artifacts/ \;
            find src-tauri/target/${{ matrix.target }}/release/bundle -name "*.app" -exec cp -r {} artifacts/ \;
          elif [ "${{ matrix.os }}" = "Windows" ]; then
            # å¤åˆ¶Windowsäº§ç‰©
            find src-tauri/target/${{ matrix.target }}/release/bundle -name "*.msi" -exec cp {} artifacts/ \;
            find src-tauri/target/${{ matrix.target }}/release/bundle -name "*.exe" -exec cp {} artifacts/ \;
          fi
          
          echo "ğŸ“‹ æ„å»ºäº§ç‰©åˆ—è¡¨:"
          ls -la artifacts/

      # ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}-artifacts
          path: artifacts/

  # åˆ›å»ºRelease
  create-release:
    needs: build-and-sign
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: Display structure of downloaded files
        run: |
          echo "ğŸ“‹ ä¸‹è½½çš„æ–‡ä»¶ç»“æ„:"
          ls -la release-artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: 'MiaoWuTodo ${{ github.ref_name }}'
          body: |
            ## MiaoWuTodo ${{ github.ref_name }}
            
            ### ä¸‹è½½è¯´æ˜
            - **macOS**: ä¸‹è½½ `.dmg` æ–‡ä»¶
            - **Windows**: ä¸‹è½½ `.msi` æˆ– `.exe` æ–‡ä»¶
            
            ### æ›´æ–°å†…å®¹
            è¯·æŸ¥çœ‹æäº¤å†å²äº†è§£è¯¦ç»†æ›´æ–°å†…å®¹ã€‚
            
            ---
            æ„å»ºæ—¶é—´: ${{ github.run_id }}
          files: release-artifacts/**/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}