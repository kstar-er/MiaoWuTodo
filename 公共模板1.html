
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{title}}</title>
    <style>
        * { box-sizing: border-box; font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; margin: 0; padding: 0; }
        body { background-color: #f5f7fa; color: #333; padding: 20px; line-height: 1.6; }
        .report-container { max-width: 1000px; margin: 20px auto; background: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); padding: 30px; }
        header { border-bottom: 2px solid #eaeaea; padding-bottom: 20px; margin-bottom: 25px; }
        h1 { color: #2c3e50; }
        .meta { color: #7f8c8d; margin-top: 8px; font-size: 0.95em; }
        .period { background: #e8f4fc; padding: 3px 8px; border-radius: 4px; }
        .metric-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin: 25px 0; }
        .metric-card { background: #f8fafc; border-left: 4px solid #3498db; padding: 15px; border-radius: 6px; }
        .metric-card.critical { border-left-color: #e74c3c; }
        .metric-value { font-size: 2em; font-weight: bold; color: #2c3e50; }
        .metric-desc { font-size: 0.9em; color: #666; margin-top: 5px; }
        .section { margin: 30px 0; }
        h2 { color: #34495e; padding-bottom: 10px; border-bottom: 1px dashed #ddd; margin-bottom: 15px; }
        .task-list { list-style: none; }
        .task-item { padding: 12px 15px; background: #f9f9f9; margin-bottom: 10px; border-radius: 8px; border: 1px solid #eee; }
        .status { display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 0.85em; margin-right: 10px; }
        .status-done { background: #d5edda; color: #155724; }
        .status-doing { background: #fff3cd; color: #856404; }
        .status-blocked { background: #f8d7da; color: #721c24; }
        .risk-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .risk-table th, .risk-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
        .risk-table tr:hover { background-color: #f5f5f5; }
        .tag-high { background: #f8d7da; color: #721c24; padding: 2px 8px; border-radius: 10px; font-size: 0.85em; }
        .next-plan { background: #e8f6f3; padding: 15px; border-radius: 8px; margin-top: 10px; }
        .ai-note { background: #fef9e7; border-left: 4px solid #f1c40f; padding: 15px; margin-top: 25px; font-style: italic; border-radius: 0 8px 8px 0; }
        .expand-detail { color: #3498db; cursor: pointer; font-size: 0.9em; text-decoration: underline; margin-top: 8px; display: inline-block; }
        .detail-content { display: none; margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; }
        .control-buttons { text-align: right; margin-bottom: 20px; }
        .control-buttons button { background: #3498db; color: white; border: none; padding: 8px 16px; margin-left: 10px; border-radius: 4px; cursor: pointer; font-size: 0.9em; }
        .control-buttons button:hover { background: #2980b9; }
        .loading { text-align: center; padding: 50px; color: #7f8c8d; }
        @media print { .control-buttons { display: none; } }
        .team-table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .team-table th, .team-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        .team-table th { background: #f8f9fa; font-weight: 600; color: #2c3e50; }
        .team-table tr:hover { background-color: #f8f9fa; }
        .team-table tr:last-child td { border-bottom: none; }
        .completion-bar { width: 100px; height: 8px; background: #ecf0f1; border-radius: 4px; overflow: hidden; display: inline-block; margin-right: 8px; }
        .completion-fill { height: 100%; border-radius: 4px; transition: width 0.3s ease; }
        .completion-excellent { background: #27ae60; }
        .completion-good { background: #f39c12; }
        .completion-poor { background: #e74c3c; }
        .performance-badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 0.8em; font-weight: 500; }
        .badge-excellent { background: #d5edda; color: #155724; }
        .badge-good { background: #fff3cd; color: #856404; }
        .badge-poor { background: #f8d7da; color: #721c24; }
        .team-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 15px 0; }
        .team-stat-card { background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #3498db; }
        .team-stat-value { font-size: 1.5em; font-weight: bold; color: #2c3e50; }
        .team-stat-desc { font-size: 0.9em; color: #666; margin-top: 5px; }
        .project-item { background: #f9f9f9; padding: 15px; margin-bottom: 12px; border-radius: 8px; border-left: 4px solid #9b59b6; }
        .project-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .project-name { font-weight: 600; font-size: 1.05em; color: #2c3e50; }
        .project-stats { font-size: 0.9em; color: #7f8c8d; }
        .project-progress { width: 100%; height: 10px; background: #ecf0f1; border-radius: 5px; overflow: hidden; margin-top: 8px; }
        .project-progress-fill { height: 100%; background: linear-gradient(90deg, #9b59b6, #8e44ad); transition: width 0.3s ease; }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <h2>ğŸ“Š æ­£åœ¨åŠ è½½å‘¨æŠ¥æ•°æ®...</h2>
        <p>è¯·ç¨å€™ï¼Œæ­£åœ¨ä» report.json è¯»å–æ•°æ®</p>
    </div>
    
    <div class="report-container" id="report-content" style="display: none;">
        <div class="control-buttons">
            <!-- <button onclick="refreshData()">ğŸ”„ åˆ·æ–°æ•°æ®</button> -->
            <button onclick="exportToPDF()">ğŸ“„ å¯¼å‡ºPDF</button>
        </div>
        
        <header>
            <h1>ğŸ¤– {{title}}</h1>
            <p class="meta">ç”Ÿæˆå‘¨æœŸ: <span class="period">{{reportStartDate}} è‡³ {{reportEndDate}}</span> | ç”Ÿæˆæ—¶é—´: {{generationTime}} | å›¢é˜Ÿ: {{teamName}}</p>
        </header>

        <section class="section">
            <h2>ğŸ“ˆ æ ¸å¿ƒæ•°æ®æ‘˜è¦</h2>
            <div class="metric-grid">
                <div class="metric-card">
                    <div class="metric-value">{{completionRate}}%</div>
                    <div class="metric-desc">ä»»åŠ¡å®Œæˆç‡ <br><small>({{completedTasks}}/{{totalTasks}}é¡¹)</small></div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">{{newTasks}}</div>
                    <div class="metric-desc">æ–°å¢ä»»åŠ¡æ•°</div>
                </div>
                <div class="metric-card critical">
                    <div class="metric-value">{{overdueTask}}</div>
                    <div class="metric-desc">è¶…æ—¶ä»»åŠ¡æ•°</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">{{inProgressTasks}}</div>
                    <div class="metric-desc">è¿›è¡Œä¸­ä»»åŠ¡ <br><small>(å¹³å‡è¿›åº¦{{avgProgress}}%)</small></div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">{{highPriorityTasks}}</div>
                    <div class="metric-desc">é«˜ä¼˜å…ˆçº§ä»»åŠ¡ <br><small>(å®Œæˆç‡{{highPriorityCompletionRate}}%)</small></div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">{{projectCount}}</div>
                    <div class="metric-desc">æ¶‰åŠé¡¹ç›®æ•° <br><small>(ä¸»è¦é¡¹ç›®ï¼š{{mainProject}})</small></div>
                </div>
            </div>
        </section>

        <section class="section">
            <h2>ğŸ—‚ï¸ æœ¬å‘¨å·¥ä½œè¯¦æƒ…</h2>
            <h3>ğŸ“‹ ä»»åŠ¡åˆ†ç±»ç»Ÿè®¡</h3>
            <ul class="task-list">
                <li class="task-item">
                    <span class="status status-done">âœ… å·²å®Œæˆ</span>
                    <strong>{{completedTasks}}ä¸ªä»»åŠ¡</strong> - æŒ‰æ—¶å®Œæˆ{{onTimeCompleted}}ä¸ªï¼Œå»¶æœŸå®Œæˆ{{lateCompleted}}ä¸ª
                </li>
                <li class="task-item">
                    <span class="status status-doing">ğŸ”„ è¿›è¡Œä¸­</span>
                    <strong>{{inProgressTasks}}ä¸ªä»»åŠ¡</strong> - å¹³å‡è¿›åº¦{{avgProgress}}%ï¼Œé¢„è®¡å®Œæˆå¤©æ•°{{avgCompletionDays}}å¤©
                </li>
                <li class="task-item">
                    <span class="status status-blocked">âš ï¸ è¶…æ—¶ä»»åŠ¡</span>
                    <strong>{{overdueTask}}ä¸ªä»»åŠ¡</strong> - å³å°†è¶…æ—¶{{soonOverdueTasks}}ä¸ª
                </li>
            </ul>

            <h3>ğŸ“Š å›¢é˜Ÿæˆå‘˜è¯¦ç»†è¡¨ç°</h3>
            <div id="team-performance-table">
                <!-- å›¢é˜Ÿè¡¨ç°è¡¨æ ¼å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </section>

        <section class="section">
            <!-- <h2>âš ï¸ é£é™©ä¸é—®é¢˜è·Ÿè¸ª</h2>
            <div class="metric-grid">
                <div class="metric-card">
                    <div class="metric-value">{{pendingReview}}</div>
                    <div class="metric-desc">å¾…å®¡æ ¸ä»»åŠ¡</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">{{approvedTasks}}</div>
                    <div class="metric-desc">å®¡æ ¸é€šè¿‡ä»»åŠ¡</div>
                </div>
                <div class="metric-card critical">
                    <div class="metric-value">{{rejectedTasks}}</div>
                    <div class="metric-desc">å®¡æ ¸é©³å›ä»»åŠ¡</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">{{approvalRate}}%</div>
                    <div class="metric-desc">å®¡æ ¸é€šè¿‡ç‡</div>
                </div>
            </div> -->
            <h2>ğŸ“Š ä»»åŠ¡ç»Ÿè®¡æ•°æ®</h2>

            <h3>ğŸ“… æ¯æ—¥ä»»åŠ¡ç»Ÿè®¡</h3>
            <div id="daily-trend-chart" style="width: 100%; height: 350px;"></div>
            
            <h3>ğŸ” å­ä»»åŠ¡ç»Ÿè®¡</h3>
            <ul class="task-list">
                <li class="task-item">
                    <strong>çˆ¶ä»»åŠ¡ï¼š</strong>{{parentTasks}}ä¸ªï¼Œå­ä»»åŠ¡ï¼š{{subTasks}}ä¸ªï¼Œå­ä»»åŠ¡å®Œæˆç‡ï¼š{{subTaskCompletionRate}}%
                </li>
            </ul>

            <h3>ğŸ“¦ é¡¹ç›®ä»»åŠ¡åˆ†å¸ƒ</h3>
            <div id="project-distribution">
                <!-- é¡¹ç›®åˆ†å¸ƒå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </section>

        <!-- æœ€åæ˜¾ç¤ºå‘¨æŠ¥åˆ†æå†…å®¹ -->
        <section class="section">
            <div id="ai-analysis-content"></div>
        </section>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.0.0/marked.min.js"></script>

    <script>

        window.addEventListener('message', function (event) {
            try {

                const jsonData = event.data;
                if (!jsonData || !jsonData.title) return;

                // æ”¶åˆ°æ•°æ®åéšè— loadingï¼Œæ¸²æŸ“æ¨¡æ¿
                document.getElementById('loading').style.display = 'none';
                document.getElementById('report-content').style.display = 'block';

                renderTemplate(jsonData);
                if (jsonData.dailyTrends || jsonData.projectDistribution) {

                    const chartData = {
                        dailyTrends: jsonData.dailyTrends || [],
                        projectDistribution: jsonData.projectDistribution || []
                    }
                    renderCharts(chartData);
                }
                
                // æ¸²æŸ“å›¢é˜Ÿè¡¨ç°
                if (jsonData.teamPerformance) {
                    renderTeamPerformance(jsonData.teamPerformance);
                }

                // æ¸²æŸ“aiæŠ¥å‘Š
                if (event.data.aiContent) {
                    renderAIContent(event.data.aiContent)
                }
                
                
                // éšè—åŠ è½½çŠ¶æ€ï¼Œæ˜¾ç¤ºæŠ¥å‘Šå†…å®¹
                document.getElementById('loading').style.display = 'none';
                document.getElementById('report-content').style.display = 'block';

            } catch (error) {
                console.error('åŠ è½½æŠ¥å‘Šæ•°æ®å¤±è´¥:', error);
                document.getElementById('loading').innerHTML = '<div style="text-align:center;padding:50px;color:#e74c3c;"><h2>âŒ æ•°æ®åŠ è½½å¤±è´¥</h2><p>é”™è¯¯ä¿¡æ¯: ' + error.message + '</p><button onclick="loadReportData()" style="background:#e74c3c;color:white;border:none;padding:10px 20px;border-radius:4px;cursor:pointer;">é‡æ–°åŠ è½½</button></div>';
            }
        });

        // åˆ‡æ¢è¯¦æƒ…æ˜¾ç¤º
        function toggleDetail(element) {
            const detail = element.nextElementSibling;
            const isHidden = detail.style.display === 'none' || detail.style.display === '';
            detail.style.display = isHidden ? 'block' : 'none';
            element.textContent = isHidden ? 'æ”¶èµ·è¯¦æƒ…' : 'æŸ¥çœ‹è¯¦æƒ…';
        }

        function getJsonFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const key = urlParams.get('key');
            if (key) {
                try {
                const data = localStorage.getItem(key);
                if (data) {
                   localStorage.removeItem(key); // ç”¨å®Œå³åˆ 
                    return JSON.parse(data);
                }
                }  catch (e) {
                console.error("è¯»å–æœ¬åœ°å­˜å‚¨å¤±è´¥:", e);
                return null;
                }
            }
            return null;
        }


        // ä»JSONæ–‡ä»¶åŠ è½½æ•°æ®å¹¶æ¸²æŸ“æ¨¡æ¿
        async function loadReportData() {
            try {
                const jsonData = getJsonFromUrl();

                if (!jsonData) {
                    document.getElementById('loading').innerHTML = '<h2>âŒ æœªæ‰¾åˆ°æŠ¥å‘Šæ•°æ®</h2>';
                    return;
                }

                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                document.getElementById('loading').style.display = 'block';
                document.getElementById('report-content').style.display = 'none';
                
                const reportData = {...jsonData};
                
                // æ¸²æŸ“æ¨¡æ¿
                renderTemplate(reportData);
                
                // æ¸²æŸ“å›¾è¡¨æ•°æ®
                if (jsonData.dailyTrends || jsonData.projectDistribution) {

                    const chartData = {
                        dailyTrends: jsonData.dailyTrends || [],
                        projectDistribution: jsonData.projectDistribution || []
                    }
                    console.log("å‡†å¤‡æ¸²æŸ“å›¾è¡¨ï¼š", chartData)
                    renderCharts(chartData);
                }
                
                // æ¸²æŸ“å›¢é˜Ÿè¡¨ç°
                if (jsonData.teamPerformance) {
                    renderTeamPerformance(jsonData.teamPerformance);
                }
                
                // éšè—åŠ è½½çŠ¶æ€ï¼Œæ˜¾ç¤ºæŠ¥å‘Šå†…å®¹
                document.getElementById('loading').style.display = 'none';
                document.getElementById('report-content').style.display = 'block';
                
                console.log('å‘¨æŠ¥æ•°æ®åŠ è½½æˆåŠŸ:', reportData);
                
            } catch (error) {
                console.error('åŠ è½½æŠ¥å‘Šæ•°æ®å¤±è´¥:', error);
                document.getElementById('loading').innerHTML = '<div style="text-align:center;padding:50px;color:#e74c3c;"><h2>âŒ æ•°æ®åŠ è½½å¤±è´¥</h2><p>é”™è¯¯ä¿¡æ¯: ' + error.message + '</p><button onclick="loadReportData()" style="background:#e74c3c;color:white;border:none;padding:10px 20px;border-radius:4px;cursor:pointer;">é‡æ–°åŠ è½½</button></div>';
            }
        }

        // æ¨¡æ¿æ¸²æŸ“å‡½æ•°
        function renderTemplate(data) {
            console.log('å‘¨æŠ¥æ¨¡æ¿æ•°æ®æ¸²æŸ“:', data);
            // è·å–æ‰€æœ‰åŒ…å«å˜é‡çš„å…ƒç´ 
            const elements = document.querySelectorAll('*');
            
            elements.forEach(element => {
                // å¤„ç†æ–‡æœ¬å†…å®¹ä¸­çš„å˜é‡
                if (element.childNodes.length > 0) {
                    element.childNodes.forEach(node => {
                        if (node.nodeType === Node.TEXT_NODE) {
                            let text = node.textContent;
                            // æ›¿æ¢æ‰€æœ‰ {{variable}} æ ¼å¼çš„å˜é‡
                            text = text.replace(/\{\{(\w+)\}\}/g, (match, key) => {
                                return data[key] !== undefined ? (data[key] === null ? '-' : data[key]) : '-';
                            });
                            node.textContent = text;
                        }
                    });
                }
                
                // å¤„ç†å±æ€§ä¸­çš„å˜é‡ï¼ˆå¦‚titleç­‰ï¼‰
                if (element.attributes) {
                    Array.from(element.attributes).forEach(attr => {
                        let value = attr.value;
                        value = value.replace(/\{\{(\w+)\}\}/g, (match, key) => {
                            return data[key] !== undefined ? (data[key] === null ? '-' : data[key]) : '-';
                        });
                        attr.value = value;
                    });
                }
            });
        }

        // æ¸²æŸ“å›¾è¡¨æ•°æ®ï¼ˆå¯é€‰ï¼Œå¦‚æœéœ€è¦å›¾è¡¨å±•ç¤ºï¼‰
        function renderCharts(chartData) {
            console.log('å›¾è¡¨æ•°æ®:', chartData);
            
            // æ¸²æŸ“é¡¹ç›®åˆ†å¸ƒ
            if (chartData.projectDistribution) {
                renderProjectDistribution(chartData.projectDistribution);
            }

            // æ¸²æŸ“æ¯æ—¥ç»Ÿè®¡è¡¨æ ¼
            if (chartData.dailyTrends) {
                renderDailyTrends(chartData.dailyTrends);
            }
        }

        // æ¸²æŸ“é¡¹ç›®åˆ†å¸ƒ
        function renderProjectDistribution(projectData) {
            const container = document.getElementById('project-distribution');
            if (!container || !projectData || projectData.length === 0) {
                return;
            }

            let html = '';
            projectData.forEach((project, index) => {
                const completionRate = (project.completed / project.tasks * 100).toFixed(1);
                const inProgress = project.tasks - project.completed;
                
                // é¡¹ç›®é¢œè‰²
                const colors = ['#9b59b6', '#3498db', '#e74c3c', '#f39c12', '#27ae60'];
                const color = colors[index % colors.length];

                html += `
                    <div class="project-item" style="border-left-color: ${color};">
                        <div class="project-header">
                            <div class="project-name">ğŸ“ ${project.projectName}</div>
                            <div class="project-stats">
                                <span style="color: #27ae60; font-weight: 600;">âœ“ ${project.completed}</span> / 
                                <span style="color: #7f8c8d;">${project.tasks} ä»»åŠ¡</span> | 
                                <span style="color: #f39c12;">è¿›è¡Œä¸­ ${inProgress}</span>
                            </div>
                        </div>
                        <div class="project-progress">
                            <div class="project-progress-fill" style="width: ${completionRate}%; background: ${color};"></div>
                        </div>
                        <div style="margin-top: 5px; font-size: 0.85em; color: #7f8c8d;">
                            å®Œæˆç‡: <strong style="color: ${color};">${completionRate}%</strong>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            console.log('é¡¹ç›®åˆ†å¸ƒæ¸²æŸ“å®Œæˆ');
        }

        // æ¸²æŸ“æ¯æ—¥ç»Ÿè®¡
        function renderDailyTrends(dailyTrends) {
            console.log('æ¯æ—¥æ•°æ®ç»Ÿè®¡ï¼š', dailyTrends)
            if (!dailyTrends || dailyTrends.length === 0) {
                console.log('æš‚æ— æ¯æ—¥è¶‹åŠ¿æ•°æ®');
                document.getElementById('daily-trend-chart').innerHTML = '<p style="color:#999; text-align:center;">æš‚æ— æ¯æ—¥è¶‹åŠ¿æ•°æ®</p>';
                return;
            }

           try {
                const myChart = echarts.init(document.getElementById('daily-trend-chart'));
                const dates = dailyTrends.map(d => d.date);
                const completed = dailyTrends.map(d => d.completed || 0);
                const newTasks = dailyTrends.map(d => d.newTasks || 0);
                const overdue = dailyTrends.map(d => d.overdue || 0);

                const option = {
                    tooltip: { trigger: 'axis' },
                    legend: { data: ['å®Œæˆä»»åŠ¡', 'æ–°å¢ä»»åŠ¡', 'è¶…æ—¶ä»»åŠ¡'] },
                    grid: {
                        left: '5%',
                        right: '5%',
                        bottom: '15%',
                        containLabel: true
                    },
                    barGap: '2%',
                    xAxis: {
                        type: 'category',
                        data: dates,
                        axisLabel: {
                            formatter: function(value) {
                                return value.split('-').slice(1).join('-'); // æ˜¾ç¤º 01-11
                            }
                        }
                    },
                    yAxis: {
                        type: 'value',
                        name: 'æ•°é‡',
                        axisLabel: {
                            formatter: '{value}'
                        }
                    },
                    series: [
                        {
                            name: 'å®Œæˆä»»åŠ¡',
                            type: 'bar',
                            data: completed,
                            label: {
                                show: true,           // æ˜¾ç¤ºæ ‡ç­¾
                                position: 'top',       // æ ‡ç­¾ä½ç½®ï¼šé¡¶éƒ¨
                                formatter: '{c}'       // æ˜¾ç¤ºæ•°å€¼
                            },
                            itemStyle: {
                                color: '#27ae60'
                            }
                        },
                        {
                            name: 'æ–°å¢ä»»åŠ¡',
                            type: 'bar',
                            data: newTasks,
                            label: {
                                show: true,
                                position: 'top',
                                formatter: '{c}'
                            },
                            itemStyle: {
                                color: '#3498db'
                            }
                        },
                        {
                            name: 'è¶…æ—¶ä»»åŠ¡',
                            type: 'bar',
                            data: overdue,
                            label: {
                                show: true,
                                position: 'top',
                                formatter: '{c}'
                            },
                            itemStyle: {
                                color: '#e74c3c'
                            }
                        }
                    ]
                };

                myChart.setOption(option);


                console.log("mychart", myChart)
            } catch (error) {
                console.error('å›¾è¡¨æ¸²æŸ“å¤±è´¥:', error);
                document.getElementById('daily-trend-chart').innerHTML = `<p style="color:red; text-align:center;">å›¾è¡¨æ¸²æŸ“å¤±è´¥: ${error.message}</p>`;
            };
        }

        // æ¸²æŸ“å›¢é˜Ÿè¡¨ç°æ•°æ®
        function renderTeamPerformance(teamData) {
            const container = document.getElementById('team-performance-table');
            if (!container || !teamData || teamData.length === 0) {
                return;
            }

            // è®¡ç®—å›¢é˜Ÿç»Ÿè®¡æ•°æ®
            const totalTasks = teamData.reduce((sum, member) => sum + member.tasks, 0);
            const totalCompleted = teamData.reduce((sum, member) => sum + member.completed, 0);
            const avgCompletionRate = (totalCompleted / totalTasks * 100).toFixed(1);
            const activeMembers = teamData.filter(m => m.tasks > 0).length;

            // åˆ›å»ºå›¢é˜Ÿç»Ÿè®¡å¡ç‰‡
            const statsHtml = `
                <div class="team-stats">
                    <div class="team-stat-card">
                        <div class="team-stat-value">${activeMembers}</div>
                        <div class="team-stat-desc">æ´»è·ƒæˆå‘˜æ•°</div>
                    </div>
                    <div class="team-stat-card">
                        <div class="team-stat-value">${totalTasks}</div>
                        <div class="team-stat-desc">å›¢é˜Ÿæ€»ä»»åŠ¡æ•°</div>
                    </div>
                    <div class="team-stat-card">
                        <div class="team-stat-value">${totalCompleted}</div>
                        <div class="team-stat-desc">å›¢é˜Ÿå®Œæˆä»»åŠ¡æ•°</div>
                    </div>
                    <div class="team-stat-card">
                        <div class="team-stat-value">${avgCompletionRate}%</div>
                        <div class="team-stat-desc">å›¢é˜Ÿå¹³å‡å®Œæˆç‡</div>
                    </div>
                </div>
            `;

            // åˆ›å»ºè¡¨æ ¼
            let tableHtml = `
                ${statsHtml}
                <table class="team-table">
                    <thead>
                        <tr>
                            <th>æ’å</th>
                            <th>æˆå‘˜å§“å</th>
                            <th>è´Ÿè´£ä»»åŠ¡æ•°</th>
                            <th>å·²å®Œæˆ</th>
                            <th>è¿›è¡Œä¸­</th>
                            <th>å®Œæˆç‡</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // æŒ‰å®Œæˆç‡æ’åº
            const sortedTeam = [...teamData].sort((a, b) => b.completionRate - a.completionRate);

            sortedTeam.forEach((member, index) => {
                const inProgress = member.tasks - member.completed;
                const completionRate = member.completionRate;
                
                // ç¡®å®šå®Œæˆç‡é¢œè‰²
                let fillClass = 'completion-poor';
                
                if (completionRate >= 80) {
                    fillClass = 'completion-excellent';
                } else if (completionRate >= 60) {
                    fillClass = 'completion-good';
                }

                // æ·»åŠ æ’åå›¾æ ‡
                let rankIcon = '';
                if (index === 0) rankIcon = 'ğŸ¥‡';
                else if (index === 1) rankIcon = 'ğŸ¥ˆ';
                else if (index === 2) rankIcon = 'ğŸ¥‰';
                else rankIcon = `${index + 1}`;

                tableHtml += `
                    <tr>
                        <td style="font-weight: bold; font-size: 1.1em;">${rankIcon}</td>
                        <td><strong>${member.name}</strong></td>
                        <td>${member.tasks}</td>
                        <td style="color: #27ae60; font-weight: 600;">${member.completed}</td>
                        <td style="color: #f39c12;">${inProgress}</td>
                        <td>
                            <div class="completion-bar">
                                <div class="completion-fill ${fillClass}" style="width: ${completionRate}%"></div>
                            </div>
                            <span style="font-weight: 600;">${completionRate.toFixed(1)}%</span>
                        </td>
                    </tr>
                `;
            });

            tableHtml += `
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHtml;
            console.log('å›¢é˜Ÿè¡¨ç°æ•°æ®æ¸²æŸ“å®Œæˆ');
        }

        // æ¸²æŸ“aiç”Ÿæˆçš„markdownæ ¼å¼å†…å®¹
        let marked = window.marked;

        if (typeof marked === 'object' && typeof marked.parse === 'function') {
            marked = marked.parse;
        }

        function renderAIContent(content) {
            const aiContentContainer = document.getElementById('ai-analysis-content');
            if (aiContentContainer && content) {
                try {
                    // ä½¿ç”¨ marked å°† Markdown è½¬ä¸º HTML
                    const htmlContent = marked(content, {
                        breaks: true,    // æ”¯æŒæ¢è¡Œ
                        gfm: true        // å¯ç”¨ GitHub Flavored Markdown
                    });

                    aiContentContainer.innerHTML = htmlContent;

                    // æ‰‹åŠ¨å¢å¼ºæ ·å¼
                    const h2s = aiContentContainer.querySelectorAll('h2');
                    h2s.forEach(h => {
                        h.style.marginTop = '20px';
                        h.style.marginBottom = '15px';
                        h.style.borderBottom = '1px dashed #ddd';
                    });

                    const ps = aiContentContainer.querySelectorAll('p');
                    ps.forEach(p => {
                        p.style.marginTop = '12px';
                        p.style.marginBottom = '5px';
                    });

                    // æ·»åŠ ä»»åŠ¡é¡¹æ ·å¼
                    const lis = aiContentContainer.querySelectorAll('li');
                    lis.forEach(li => {
                        if (li.parentElement.tagName === 'UL') {
                            li.style.padding = '8px 12px';
                            li.style.marginBottom = '5px';
                            li.style.background = '#f9f9f9';
                            li.style.borderRadius = '6px';
                            li.style.borderLeft = '3px solid #3498db';
                            li.style.marginLeft = '2em';
                        }
                    });

                    const ols = aiContentContainer.querySelectorAll('ol');
                    ols.forEach(ol => {
                        ol.style.marginLeft = '1em';
                    });
                } catch (err) {
                    console.error('Markdown æ¸²æŸ“å¤±è´¥:', err);
                    aiContentContainer.innerHTML = '<p style="color:red;">âŒ Markdown è§£æé”™è¯¯ï¼Œè¯·æ£€æŸ¥å†…å®¹æ ¼å¼ã€‚</p>';
                }
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        // document.addEventListener('DOMContentLoaded', function() {
        //     loadReportData();
        // });

        // å¯¼å‡ºPDFåŠŸèƒ½
        function exportToPDF() {
            window.print();
        }

        // åˆ·æ–°æ•°æ®åŠŸèƒ½
        // function refreshData() {
        //     loadReportData();
        // }
    </script>
</body>
</html>